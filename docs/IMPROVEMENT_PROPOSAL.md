# タスク詳細収集フロー改善提案

## 調査日: 2026-02-01

## 1. 発見した問題点

### 🔴 **重大なUX問題**

#### 1.1 機械的すぎる会話フロー
**現状:**
```
ユーザー: 「明日までにレポート書く」
AI: カテゴリは？ → 期限は？ → 実行予定は？ → 所要時間は？
```

**問題:**
- ユーザーが「明日までに」と明示的に入力したのに、「期限は？」と聞く
- 同じ情報を2度聞く形になり、ユーザーは「既に言ったのに？」と感じる
- 7つの選択肢（カテゴリ5つ + スキップ + とりあえず登録）を一度に表示し画面が煩雑

#### 1.2 強制的なフィールド収集
**現状:**
- 必ずtitle → category → deadline → scheduledAt → durationMinutes の順で聞く
- ユーザーが途中で満足しても、明示的に「とりあえず登録」を選ばないと終了できない
- 「スキップ」を押す操作が多すぎる

#### 1.3 状態管理の複雑さ
**現在の状態変数:**
- `isFirstInput`: 初回入力フラグ
- `pendingTaskInfo`: 一時保存タスク情報  
- `conversation.currentField`: 現在の質問フィールド
- `conversation.currentTaskInfo`: 収集中のタスク情報
- `isLoading`: ローディング状態

**問題:**
- 5つの状態が絡み合い、デバッグ困難
- 予期せぬ状態遷移が発生しやすい
- テストが複雑で網羅が難しい

---

## 2. 改善提案

### ✅ **提案1: スマートな質問戦略（Smart Questioning）**

#### 内容
ユーザーが既に入力した情報は聞かない。不足している情報のみを質問する。

#### 実装案
```typescript
// 入力に含まれる情報を検出
const detectedFields = detectFieldsInInput(userInput);
// 検出されたフィールドは質問対象から除外
const fieldsToAsk = REQUIRED_FIELDS.filter(f => !detectedFields.includes(f));
```

#### 期待される効果
- ユーザーの入力を尊重した自然な会話
- 質問回数の削減（平均2-3回 → 1-2回）
- ユーザー満足度向上

---

### ✅ **提案2: プログレッシブ開示（Progressive Disclosure）**

#### 内容
選択肢を段階的に表示し、画面をシンプルに保つ。

#### 実装案
```typescript
// 選択肢を階層化
const PRIMARY_OPTIONS = ["仕事", "個人", "その他"]; // よく使うもの
const SECONDARY_OPTIONS = ["買い物", "返信"]; // 詳細選択肢
// 「もっと見る」でSECONDARYを表示
```

#### UI案
```
このタスクのカテゴリは？
[仕事] [個人] [その他] [もっと見る▼]

入力欄: ________________
[スキップ] [とりあえず登録]
```

#### 期待される効果
- 画面のシンプル化
- 認知負荷の軽減
- スマホでの操作性向上

---

### ✅ **提案3: 初回入力の即時確認（One-Shot Registration）**

#### 内容
初回入力で十分な情報が揃った場合は、追加質問せず即座に確認画面へ。

#### 判定基準案
```typescript
function shouldAskMore(taskInfo: TaskInfo, userInput: string): boolean {
  // title + categoryが揃っている
  const hasRequired = taskInfo.title && taskInfo.category;
  // かつ、追加情報（deadline/scheduledAt/duration）が1つ以上ある
  const hasOptional = taskInfo.deadline || taskInfo.scheduledAt || taskInfo.durationMinutes;
  
  return !(hasRequired && hasOptional);
}
```

#### 期待される効果
- パワーユーザーの入力効率向上
- 短いタスク（「買い物」など）の迅速な登録
- 会話の自然な終了感

---

### ✅ **提案4: コンテキスト理解の強化（Context Awareness）**

#### 内容
入力テキストから意図を読み取り、関連する質問をまとめて行う。

#### 例
```
ユーザー: 「明日の朝9時に会議、1時間程度」
↓
AI検出: deadline=明日, scheduledAt=9:00, durationMinutes=60, title=会議
↓
AI: 「会議ですね。カテゴリは？【仕事/個人/その他】」
→ タイトルは必要なければスキップ可
```

#### 実装案
```typescript
// LLMにコンテキストを渡して、まとめて解析
const prompt = `
ユーザー入力: "${input}"
現在のタスク情報: ${JSON.stringify(currentTaskInfo)}

この入力から読み取れるすべての情報を抽出してください。
不明瞭な点があれば、1つの質問にまとめて確認してください。
`;
```

#### 期待される効果
- 会話の円滑化
- LLM呼び出し回数の削減
- ユーザーの入力を最大限活用

---

### ✅ **提案5: 状態管理の単純化（Simplified State Machine）**

#### 内容
複雑な状態を整理し、明確な状態遷移図を作成する。

#### 提案する状態定義
```typescript
type ConversationPhase = 
  | "idle"           // 開始前
  | "parsing"        // LLM解析中
  | "confirming"     // 最終確認
  | "collecting"     // 情報収集中
  | "completed";     // 完了

interface ConversationState {
  phase: ConversationPhase;
  taskInfo: Partial<TaskInfo>;
  context: string;
  // currentFieldを削除 - 動的に計算
}
```

#### 期待される効果
- コードの保守性向上
- 予期せぬバグの減少
- 新機能追加の容易さ

---

## 3. 実装の優先順位

### **Phase 1: 即座に実装可能（高効果・低コスト）**
1. ✅ **スマートな質問戦略** - 入力に含まれる情報を検出
2. ✅ **プログレッシブ開示** - 選択肢の段階的表示

### **Phase 2: 検討必要（実装前に再評価）** ⚠️

> **メモ:** 以下の改善案については、実装前に要件と効果を再検討すること

3. ⏸️ **初回入力の即時確認** - 条件付きでスキップ
   - **検討点:** ユーザーが「とりあえず登録」オプションを使えば同等の効果がある
   - **判断基準:** Phase 1実装後のユーザーフィードバックを見て決定

4. ⏸️ **コンテキスト理解の強化** - LLMプロンプト改善
   - **検討点:** 現在のLLM実装で既にどこまでできるか確認が必要
   - **判断基準:** APIログ分析で抽出精度を測定してから判断

### **Phase 3: 壁打ち・検討ステージ** 🤔

> **メモ:** 実装検討前に壁打ちが必要。良い方向に動くか不確定

5. ❓ **状態管理の単純化** - リファクタリング
   - **懸念事項:** 
     - 現在の実装で「問題が起きていない」
     - リファクタリングによるリスク（バグ混入、工数）
     - 新機能追加時に複雑さが実際に障害になるか未検証
   - **壁打ち項目:**
     - どの状態変数を削減できるか
     - 単純化後の具体的なコード構成
     - テストカバレッジの影響
   - **判断基準:** Phase 1・2実装後、新機能追加で苦労したら検討

---

## 実装ロードマップ

### **今すぐ実装: Phase 1** 🚀
- ✅ スマートな質問戦略
- ✅ プログレッシブ開示

### **実装後に検討: Phase 2** 📋
- Phase 1の効果測定 → ユーザーフィードバック収集 → 判断

### **必要になったら: Phase 3** 💭
- 状態管理が障害になる実例が出たら壁打ち開始

---

## 4. 要件定義との整合性

> tiimoにインスピレーションを得た、自然言語でタスクを入力し、LLMが解析・ラベル付け・スケジューリングを行う

**改善提案との整合:**
- ✅ 自然言語入力の尊重（提案1, 4）
- ✅ LLMのスマート活用（提案4）
- ✅ 視覚的にわかりやすいUI（提案2）
- ✅ tiimoライクな直感的操作（提案3）

---

## 5. まとめ

### **Before（現在）**
- 機械的な質問連打
- 7つの選択肢の情報過多
- 同じ情報を2度聞く
- 複雑な状態管理

### **After（提案後）**
- コンテキストを理解した質問
- 段階的な選択肢表示
- 入力を尊重した会話
- シンプルな状態管理

**期待される効果:**
- ユーザーのタスク登録時間 50%削減
- 会話の自然さ向上
- コードの保守性向上
- スマホでの使いやすさ向上
